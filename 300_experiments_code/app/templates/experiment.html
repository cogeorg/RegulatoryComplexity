{% extends "base.html" %}
{% import 'bootstrap/wtf.html' as wtf %}

{% block app_content %}
<!-- <a class="btn btn-info btn-small" role="button" data-toggle="popover" data-trigger="hover" title="Rules" data-content="And here's some amazing content. It's very engaging. Right?" id="example">Dismissible popover</a> -->

<style>

  input[type="text"],
  select.form-control {
    background: transparent;
    border: none;
    border-bottom: 2px solid #003A70;
    -webkit-box-shadow: none;
    box-shadow: none;
    border-radius: 0;
  }

  input[type="text"]:focus,
  select.form-control:focus {
    -webkit-box-shadow: none;
    box-shadow: none;
  }

  .navbar {
    display: none;
  }

  body > div > div:nth-child(2) > div:nth-child(1), body > div.container-fluid > div:nth-child(2) > div:nth-child(3) {
    margin: 10px auto;
  }
  
  body > div > div.jumbotron {
    margin-bottom: 0px;
  }

  body > div > div:nth-child(2) {
    margin-bottom: 10px;
  }

  body > div > div:nth-child(2) > div.col-lg-8 > h2 {
    margin-top: 10px;
  }

  .container-fluid {
    margin-top: 10px;
  }

  .p-70 {
    padding: 0px 70px !important;
  }

  .px-20 {
    padding-top: 20px !important;
    padding-bottom: 20px !important;
  }

  #n_reg {
      display: none;
    }

  body > div > div:nth-child(4) > div.col-sm-3.mb-1.mb-lg-0 > div > form > div:nth-child(3) > label {
    display: none;
  }

  table > tbody > tr:nth-child(1) > td {
    padding-top: 20px !important;
  }
  
  table {
    border: #ffffff;
    font-size: 13px; 
    width: 100%;
  }

  table thead {
    border-bottom: 2px solid #000000;
  }

  table > thead > tr > th:nth-child(1) {
    color: white;
  }

  td, th { 
    border: 1px solid white;
  }

  table > tbody > tr > td:nth-child(1) {
      font-weight: 500;
      text-align: right;
      padding-right: 20px
  }

  .help-block {
    font-size: 14px !important;
    font-weight: 400 !important;
    line-height: 17px !important;
  }

  .modal {
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    right: 0;
    display: none;
    overflow: auto;
    background-color: #000000;
    background-color: rgba(0, 0, 0, 0.7);
    z-index: 9999;
}

#modalCorrect, #modalWrong{
  display: none;
}

.modal-window {
    position: relative;
    background-color: #FFFFFF;
    width: 50%;
    margin: 10% auto;
    padding: 20px;
}

.modal-window.small {
    width: 30%;
}

.modal-window.large {
    width: 75%;
}

.close {
    position: absolute;
    top: 0;
    right: 0;
    color: rgba(0,0,0,0.3);
    height: 30px;
    width: 30px;
    font-size: 30px;
    line-height: 30px;
    text-align: center;
}

.close:hover,
.close:focus {
    color: #000000;
    cursor: pointer;
}

.open {
    display: block;
}

.align-wtf-modal {
  display: flex;
  align-content: end;
  justify-content: end;
}

.w3-modal{z-index:3;display:none;padding-top:100px;position:fixed;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgb(0,0,0);background-color:rgba(0,0,0,0.4)}

</style>

<body onload="startTime() ; enablepopover() ; loadregulation();">

  <div class="row p-70">
    <div class="col-lg-2" align="left">
      <a href="/return-excel/" target="_blank"><button class='btn btn-info btn-small' style="background-color: #003A70; border-radius: 0px; border: none">Download Excel
          Template</button></a>
    </div>

  <div class="col-lg-8" align= "center">
   <h2> Regulation {{n_reg}} / 10 </h2>
  </div>

  <div class="col-lg-2" align="right">
      <button onclick="document.getElementById('id01').style.display='block'" class="btn btn-info btn-small" style="background-color: #003A70; border-radius: 0px; border: none">Rules</button>
  </div> 

  <div id="id01" class="w3-modal">
    <div class="w3-modal-content">
      <div style="background-color: white; padding: 40px; max-width: 900px; margin-left: auto; margin-right: auto;">

        In the <i>Regulation</i> column on the left hand side of the screen you find a list of regulations applicable to
        the Balance Sheet on the right hand side of the screen. Evaluate how much <b> regulatory capital</b> the
        hypothetical bank, based in France (which is in the European Union), is required to have to stay solvent
        according to the rules given in the Regulation column. Enter your answer (in EUR) as fast as possible in the
        <b>Enter answer</b> field and click 'Save and continue'.<br>
        <br>
        In the <i>Balance Sheet</i> column on the right of the screen you see the asset side of a hypothetical bank.
        Each row is an entry on the balance sheet and the <b>Type</b> denotes what kind of entry it is. <b>Amount</b> is
        the amount, <b>Denomination</b> is the currency in which the amount is denominated (including whether it is in
        national or foreign currency), <b>Maturity</b> denotes the remaining maturity of the asset in years,
        <b>Counterparty of issuer</b> indicates who issued the asset, and the <b>Guarantor</b> indicates if another
        party guarantees the asset.<br><br>

        <div style="height: 20px">
          <a href='{{ url_for('rules') }}' target='_blank' style="float:left; padding-top: 6px; padding-bottom: 6px;"> View all rules by clicking here</a>
          <span onclick="document.getElementById('id01').style.display='none'"
            style="cursor:pointer; float: right; margin-right: 10px; background-color: #003A70; border-radius: 0px; border: none" class="btn btn-info btn-small">Close and Continue</span>
        </div>
      </div>
    </div>
  </div>
</div>
</div>

  <!-- <div class="container-full-bg"> -->
  <div class="jumbotron p-70 px-20" style="height: calc(100vh - 88px); display: flex; margin: 0 20px; border-radius: 5px;">
    <div class="row justify-content-left" style="margin-bottom: auto; margin-top: auto; width: 100%;">
      <div class="col-lg-7 vcenter" style="padding: 0px">
        <h3 align="left">Balance Sheet</h3>
        <div class="panel panel-default" style="padding:20px; min-height: 510px">
          <!-- <img src="{{ url_for('static', filename='balance_sheet1.png') }}" width="100%" alt="User balance sheet"/> -->
          <balancesheet></balancesheet>
        </div>
      </div>
      <div class="col-lg-5 vcenter">
        <h3 align="left">Regulation</h3>
        <div class="panel panel-default" style="margin-bottom: 17px;">
          <!-- <img src="{{ url_for('static', filename='regulation1.png') }}" width="100%" alt="User Regulation" /> -->
          <regulation></regulation>
        </div>
        <div class="panel panel-default" style="padding: 20px; padding-bottom: 20px; min-height: 190px"> 
          
          <div class="col-3 mb-1 mb-lg-0">
            <div id="practiceOver">
              {{ wtf.quick_form(form) }}
            </div>
          </div>
          <div id="practiceStart">
            <label class="control-label" for="answer">Enter the bank's total risk weighted assets for this regulation:</label>
            <input class="form-control" id="practiceAnswer" type="text" value="">
            <button class="btn btn-default" data-target="practiceModal" data-toggle="modal" style="position: absolute;
            right: 0;
            margin-top: 16px;
            margin-right: 35px;
            ">Save and Continue</button>
          </div>
          <div style="margin-top:16px">
            <span style="display:inline-block; font-weight: bold">Elapsed Time: </span>
            <div id="chronometer" style="display:inline-block"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- </div> -->

</div>
</div>


<!-- 5a. Set the responses to whether an answer is correct or wrong -->

  <div id="practiceModal" class="modal">
    <div id="modalWrong" class="modal-window">
      <h3>Incorrect Answer!</h3>
      <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Lorem ipsum dolor sit amet, consectetur adipiscing elit.</p>
      <div class="align-wtf-modal">{{ wtf.quick_form(form) }}</div>
    </div>
    <div id="modalCorrect" class="modal-window">
      <h3>Correct Answer!</h3>
      <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Lorem ipsum dolor sit amet, consectetur adipiscing elit.</p>
      <div class="align-wtf-modal">{{ wtf.quick_form(form) }}</div>
  </div>
</div>

</body>

<script>

// 1. Set the correct answer - This is needed for Practice Answer

theCorrectAnswer = 1;

// 2. Get regulation number - pass to variable
document.getElementById("n_reg").value = {{n_reg}};
n_reg = {{n_reg}};

// 3. Get practice answer  - pass to variable
n_answer = document.getElementById("practiceAnswer").value;

// 4. If n_reg is 1 then practice answer wtf_form will be shown - No need to change
if (n_reg == 1) {
  document.getElementById("practiceStart").classList.add('show');
  document.getElementById("practiceOver").classList.add('hidden');
} else {
  document.getElementById("practiceStart").classList.add('hidden');
  document.getElementById("practiceOver").classList.add('show');
}

document.addEventListener('click', function (e) {
e = e || window.event;
var target = e.target || e.srcElement;

// 5. If Practice Answer equals the answer set above in 1. then modalCorrect is displayed, else modalWrong is displayed. To define their responses look to point 5a. above in the html.

if (target.hasAttribute('data-toggle') && target.getAttribute('data-toggle') == 'modal') {
    if (target.hasAttribute('data-target')) {
        var m_ID = target.getAttribute('data-target');
        document.getElementById(m_ID).classList.add('open');
        let practiceAnswer = document.getElementById("practiceAnswer").value;
        if (practiceAnswer == theCorrectAnswer ) {
            document.getElementById("modalCorrect").classList.add('show');
          } else {
            document.getElementById("modalWrong").classList.add('show');
          }
      e.preventDefault();
    }
}

if ((target.hasAttribute('data-dismiss') && target.getAttribute('data-dismiss') == 'modal') || target.classList.contains('modal')) {
    var modal = document.querySelector('[class="modal open"]');
    modal.classList.remove('open');
    document.getElementById("modalCorrect").classList.remove('show');
    document.getElementById("modalWrong").classList.remove('show');
    e.preventDefault();
}
}, false);


// 6. This function resets the timer

function reset_timer() {
  startTime = new Date();
  window.localStorage.setItem('startTime', startTime);
  return startTime;
}

// 7. This function stops user from being able to go back.

history.pushState(null, null, location.href);
    window.onpopstate = function () {
        history.go(1);
    };


// 8. This function fetches the timestamp in the browsers localstorage so that if a user refreshes it will continue its count.

document.addEventListener('DOMContentLoaded', function(event) { 
  // get timestamp
startTime = new Date(window.localStorage.getItem('startTime') || resetStartTime());
// start timer
  
  window.setInterval(function() {
    var secsDiff = new Date().getTime() - startTime.getTime();
    document.getElementById('chronometer').innerText = Math.floor(secsDiff / 1000) + ' seconds' ;
  }, 1000);
});

// 9. This function outputs the regulation

fetch("../static/exercises/" + {{user_experiment_id}} + "/regulation_"+ {{user_experiment_id}}+".html")
  .then(response => {
    return response.text()
  })
  .then(data => {
    document.querySelector("regulation").innerHTML = data;
  });

// 10. This function outputs the static regulation table. Regulation can be set in table_template.csv. The csv will be converted into table.htm on the fly. 

fetch("../static/table.htm")
  .then(response => {
    return response.text()
  })
  .then(data => {
    document.querySelector("balancesheet").innerHTML = data;
  });


</script>

{%endblock%}
